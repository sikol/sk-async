/*
 * Copyright (c) 2019, 2020, 2021 SiKol Ltd.
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization
 * obtaining a copy of the software and accompanying documentation covered by
 * this license (the "Software") to use, reproduce, display, distribute,
 * execute, and transmit the Software, and to prepare derivative works of the
 * Software, and to permit third-parties to whom the Software is furnished to
 * do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including
 * the above license grant, this restriction and the following disclaimer,
 * must be included in all copies of the Software, in whole or in part, and
 * all derivative works of the Software, unless such copies or derivative
 * works are solely in the form of machine-executable object code generated by
 * a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
 * SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
 * FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */

#include <catch.hpp>

#include "sk/net/uri.hxx"

using sk::net::parse_uri;
using sk::net::uri_errors;
using sk::net::uri_options;

TEST_CASE("URI 1", "[uri]")
{
    auto u = parse_uri("http://localhost");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(!u->path);
}

TEST_CASE("URI 2", "[uri]")
{
    auto u = parse_uri("http://localhost:80");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(u->authority->port == 80);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(!u->path);
}

TEST_CASE("URI 3", "[uri]")
{
    auto u = parse_uri("http://jdoe@localhost");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(u->authority->username == "jdoe");
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(!u->path);
}

TEST_CASE("URI 4", "[uri]")
{
    auto u = parse_uri("http://jdoe:hunter2@localhost");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(u->authority->username == "jdoe");
    REQUIRE(u->authority->password == "hunter2");
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(!u->path);
}

TEST_CASE("URI 5", "[uri]")
{
    auto u = parse_uri("http://jdoe:hunter2@localhost:8080");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(u->authority->username == "jdoe");
    REQUIRE(u->authority->password == "hunter2");
    REQUIRE(u->authority->port == 8080);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(!u->path);
}

TEST_CASE("URI 6", "[uri]")
{
    auto u = parse_uri("http://jdoe:hunter2@127.0.0.1:8080");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(u->authority->username == "jdoe");
    REQUIRE(u->authority->password == "hunter2");
    REQUIRE(u->authority->port == 8080);
    REQUIRE(u->authority->hostname == "127.0.0.1");
    REQUIRE(!u->path);
}

TEST_CASE("URI 7", "[uri]")
{
    auto u = parse_uri("http://jdoe:hunter2@[2001:db8::1:2]:8080");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(u->authority->username == "jdoe");
    REQUIRE(u->authority->password == "hunter2");
    REQUIRE(u->authority->port == 8080);
    REQUIRE(u->authority->hostname == "2001:db8::1:2");
    REQUIRE(!u->path);
}

TEST_CASE("URI 8", "[uri]")
{
    auto u = parse_uri("http://localhost/");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/");
    REQUIRE(!u->path->query);
    REQUIRE(!u->path->fragment);
}

TEST_CASE("URI 9", "[uri]")
{
    auto u = parse_uri("http://localhost/some/path");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/path");
    REQUIRE(!u->path->query);
    REQUIRE(!u->path->fragment);
}

TEST_CASE("URI 10", "[uri]")
{
    auto u = parse_uri("http://localhost/some/path?query=value&other=value");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/path");
    REQUIRE(u->path->query);
    REQUIRE(u->path->query == "query=value&other=value");
}

TEST_CASE("URI 11", "[uri]")
{
    auto u = parse_uri("http://localhost/some/"
                       "path?query=value&other=value#fragment.is.here");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/path");
    REQUIRE(u->path->query);
    REQUIRE(u->path->query == "query=value&other=value");
    REQUIRE(u->path->fragment);
    REQUIRE(u->path->fragment == "fragment.is.here");
}

TEST_CASE("URI 12", "[uri]")
{
    auto u = parse_uri("http://localhost/some/"
                       "path#fragment.is.here");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(!u->authority->username);
    REQUIRE(!u->authority->password);
    REQUIRE(!u->authority->port);
    REQUIRE(u->authority->hostname == "localhost");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/path");
    REQUIRE(!u->path->query);
    REQUIRE(u->path->fragment);
    REQUIRE(u->path->fragment == "fragment.is.here");
}

TEST_CASE("URI 13", "[uri]")
{
    auto u = parse_uri("http://jdoe:hunter2@[2001:db8::1:2]:8080"
                       "/some/path?query=value&other=value#fragment.is.here");
    REQUIRE(u);
    REQUIRE(is_absolute(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(u->scheme == "http");
    REQUIRE(u->authority);
    REQUIRE(u->authority->username == "jdoe");
    REQUIRE(u->authority->password == "hunter2");
    REQUIRE(u->authority->port == 8080);
    REQUIRE(u->authority->hostname == "2001:db8::1:2");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/path");
    REQUIRE(u->path->query);
    REQUIRE(u->path->query == "query=value&other=value");
    REQUIRE(u->path->fragment);
    REQUIRE(u->path->fragment == "fragment.is.here");
}

TEST_CASE("URI with invalid high-bit characters", "[uri]")
{
    auto u = parse_uri("http://localhost/some/\xABpath");
    REQUIRE(!u);
    u = parse_uri("http://local\xABhost/some/path");
    REQUIRE(!u);
}

TEST_CASE("URI with URL-encoded ASCII path", "[uri]")
{
    auto u = parse_uri("http://localhost/%73%6F%6d%65/%70%61%74%68");
    REQUIRE(u);
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/path");
}

TEST_CASE("URI with URL-encoded UTF-8 path", "[uri]")
{
    auto u = parse_uri("http://localhost/s%C3%B3m%C3%A9/p%C3%A1th" //
                       "?qparam=s%C3%B3m%C3%A9d%C3%A1t%C3%A1"      //
                       "#%66%72%C3%A1%67%6D%C3%A9%6E%74");
    REQUIRE(u);
    REQUIRE(u->path);
    REQUIRE(u->path->path ==
            "\x2F\x73\xC3\xB3\x6D\xC3\xA9\x2F\x70\xC3\xA1\x74\x68");
    REQUIRE(u->path->query);
    REQUIRE(*u->path->query == "qparam=sómédátá");
    REQUIRE(u->path->fragment);
    REQUIRE(*u->path->fragment == "frágmént");
}

TEST_CASE("URI with raw UTF-8 path", "[uri]")
{
    auto u = parse_uri(
        "http://localhost/\x73\xC3\xB3\x6D\xC3\xA9/\x70\xC3\xA1\x74\x68",
        uri_options::skip_path_decode);
    REQUIRE(u);
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/\x73\xC3\xB3\x6D\xC3\xA9/\x70\xC3\xA1\x74\x68");
}

TEST_CASE("relative URI", "[uri]")
{
    auto u = parse_uri("/some/relative/path", uri_options::allow_relative);
    REQUIRE(u);
    REQUIRE(is_relative(*u));
    REQUIRE(!is_protocol_relative(*u));
    REQUIRE(!u->scheme);
    REQUIRE(!u->authority);
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/some/relative/path");
    REQUIRE(!u->path->query);
    REQUIRE(!u->path->fragment);
}

TEST_CASE("relative URI without flag", "[uri]")
{
    auto u = parse_uri("/some/relative/path");
    REQUIRE(!u);
    REQUIRE(u.error() == sk::net::make_uri_error(uri_errors::relative));
}

TEST_CASE("URI 15", "[uri]")
{
    auto u = parse_uri("https:/authority/relative");
    REQUIRE(!u);
}

TEST_CASE("protocol-relative URI", "[uri]")
{
    auto u =
        parse_uri("//proto.col/relative", uri_options::allow_protocol_relative);
    REQUIRE(u);
    REQUIRE(!u->scheme);
    REQUIRE(u->authority);
    REQUIRE(u->authority->hostname == "proto.col");
    REQUIRE(u->path);
    REQUIRE(u->path->path == "/relative");
    REQUIRE(!u->path->query);
    REQUIRE(!u->path->fragment);
}

TEST_CASE("protocol-relative URI without flag", "[uri]")
{
    auto u = parse_uri("//proto.col/relative");
    REQUIRE(!u);
    REQUIRE(u.error() ==
            sk::net::make_uri_error(uri_errors::protocol_relative));
}

TEST_CASE("str(uri) 1", "[uri]")
{
    auto text = "http://jdoe:hunter2@[2001:db8::1:2]:8080"
                "/some/path?query=value&other=value#fragment.is.here";
    auto uri = parse_uri(text);
    REQUIRE(uri);
    REQUIRE(str(*uri) == text);
}

TEST_CASE("uri invalid port", "[uri]")
{
    auto text = "http://localhost:808080";
    auto uri = parse_uri(text);
    REQUIRE(!uri);
    REQUIRE(uri.error() == sk::net::make_uri_error(uri_errors::invalid_port));
}

TEST_CASE("dehex", "[uri]")
{
    using sk::net::detail::dehex;

    REQUIRE(dehex('0') == 0);
    REQUIRE(dehex('1') == 1);
    REQUIRE(dehex('2') == 2);
    REQUIRE(dehex('3') == 3);
    REQUIRE(dehex('4') == 4);
    REQUIRE(dehex('5') == 5);
    REQUIRE(dehex('6') == 6);
    REQUIRE(dehex('7') == 7);
    REQUIRE(dehex('8') == 8);
    REQUIRE(dehex('9') == 9);
    REQUIRE(dehex('A') == 10);
    REQUIRE(dehex('B') == 11);
    REQUIRE(dehex('C') == 12);
    REQUIRE(dehex('D') == 13);
    REQUIRE(dehex('E') == 14);
    REQUIRE(dehex('F') == 15);
    REQUIRE(dehex('a') == 10);
    REQUIRE(dehex('b') == 11);
    REQUIRE(dehex('c') == 12);
    REQUIRE(dehex('d') == 13);
    REQUIRE(dehex('e') == 14);
    REQUIRE(dehex('f') == 15);
    REQUIRE(dehex('g') == -1);
    REQUIRE(dehex('@') == -1);
    REQUIRE(dehex('`') == -1);
    REQUIRE(dehex('/') == -1);
    REQUIRE(dehex(':') == -1);
}

TEST_CASE("empty uri", "[uri]")
{
    auto text = "";
    auto uri = parse_uri(text);
    REQUIRE(!uri);
    REQUIRE(uri.error() == sk::net::make_uri_error(uri_errors::no_data));
}

TEST_CASE("scheme-only uri", "[uri]")
{
    auto uri = parse_uri("http:");
    REQUIRE(!uri);
    uri = parse_uri("http://");
    REQUIRE(!uri);
}

auto make_uri_copy() -> sk::net::uri {
    auto uri = parse_uri("http://localhost/some/path");
    sk::net::uri uri2(*uri);
    return uri2;
}

TEST_CASE("uri is copyable", "[uri]") {
    auto uri = make_uri_copy();
    REQUIRE(uri.path->path == "/some/path");
}

auto make_uri_move() -> sk::net::uri {
    auto uri = parse_uri("http://localhost/some/path");
    return std::move(*uri);
}

TEST_CASE("uri is movable", "[uri]") {
    auto uri = make_uri_move();
    REQUIRE(uri.path->path == "/some/path");
}
